\documentclass{report}

\begin{document}
\chapter{Запросы}

\section{Представления}

Для того чтобы облегчить себе реализацию запросов создадим несколько
представлений.

1. Представление с текущим городом, как аналог глобальной константе.
Очевидно что, текущий город уже должен быть в таблице Cities.

\begin{lstlisting}
CREATE VIEW current_city AS
SELECT *
    FROM cities 
    WHERE city_name = 'Novosibirsk'; 
\end{lstlisting}

2. Представление с полным адресом, потому что часто будем фильтровать
по разным частям адреса.

\begin{lstlisting}
CREATE VIEW full_address AS
SELECT *
    FROM addresses 
    JOIN streets USING(street_id)
    JOIN districts USING(district_id)
    JOIN cities USING(city_id);
\end{lstlisting}

\section{Реализация запросов}

Переменные в запросе будем обозначать как \$(название-переменной)

\textbf{1. Получить} перечень и общее число абонентов указанной АТС полностью, 
только льготников, по возрастному признаку, по группе фамилий

\begin{lstlisting}
SELECT first_name, last_name, surname, gender, age 
    FROM $(ats_type_view)
    JOIN phone_numbers USING(ats_id)
    JOIN subscriptions USING(phone_id)
    JOIN subscribers USING(subscriber_id)
    WHERE (age >= $(subscriber_age) AND
        benefit >= $(subscriber_benefit));
\end{lstlisting}

\textbf{2. Получить} перечень и общее число свободных телефонных 
номеров на указанной АТС, по всей ГТС, по признаку возможности установки 
телефона в данном районе.

\begin{lstlisting}
SELECT phone_no 
    FROM phone_numbers_v
    JOIN full_address USING(address_id)
    JOIN ats USING(ats_id)
    WHERE (district_name = $(district_name) AND 
        ($(all_ats_query) OR ats_id = $(desired_ats)));
\end{lstlisting}

\textbf{3. Получить} перечень и общее число должников на указанной АТС, 
по всей ГТС, по данному району, абонентов, которые имеют задолженность 
уже больше недели (месяца), по признаку задолженности за межгород и (или) 
по абонентской плате, по размеру долга.

\begin{lstlisting}

\end{lstlisting}

\textbf{4. Определить} АТС (любого или конкретного типа), на которой 
самое большое (маленькое) число должников, самая большая сумма задолженности.

\begin{lstlisting}

\end{lstlisting}

\textbf{5. Получить} перечень и общее число общественных телефонов и 
таксофонов во всем городе, принадлежащих указанной АТС, по признаку 
нахожения в данном районе.

\begin{lstlisting}

\end{lstlisting}

\textbf{6. Найти} процентное соотношение обычных и льготных абонентов 
на указанной АТС, по всей ГТС, по данному району, по типам АТС.

\begin{lstlisting}

\end{lstlisting}

\textbf{7. Получить} перечень и общее число абонентов указанной АТС, 
по всей ГТС, по данному району, по типам АТС имеющих параллельные телефоны, 
только льготников имеющих параллельные телефоны.

\begin{lstlisting}

\end{lstlisting}

\textbf{8. Определить}, есть ли по данному адресу телефон, общее 
количество телефонов и (или) количество телефонов с выходом на межгород, 
с открытым выходом на межгород в данном доме, на конкретной улице.

\begin{lstlisting}

\end{lstlisting}

\textbf{9. Определить} город, с которым происходит большее количество 
междугородных переговоров.

\begin{lstlisting}

\end{lstlisting}

\textbf{10. Получить} полную информацию об абонентах с заданным телефонным номером.

\begin{lstlisting}

\end{lstlisting}

\textbf{11. Получить} перечень спаренных телефонов, для которых есть 
техническая возможность заменить их на обычные (выделить дополнительный номер).

\begin{lstlisting}

\end{lstlisting}

\textbf{12. Получить} перечень и общее число должников на указанной АТС, 
по всей ГТС, по данному району, которым следует послать письменное уведомление, 
отключить телефон и(или) выход на межгород.

\begin{lstlisting}

\end{lstlisting}

\end{document}